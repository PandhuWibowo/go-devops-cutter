#!/bin/bash
#
# Pre-push hook for go-devops-cutter
# Runs before git push to ensure code quality
#

set -e

echo "üöÄ Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [ ! -f "go.mod" ]; then
    echo -e "${RED}Error: Not in project root directory${NC}"
    exit 1
fi

# Get the remote and branch we're pushing to
remote="$1"
url="$2"

# Get current branch
branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

echo -e "${BLUE}Branch: $branch${NC}"
echo -e "${BLUE}Remote: $remote${NC}"
echo ""

# 1. Run tests with coverage
echo "üß™ Running unit tests with coverage..."
if ! make test-coverage-func; then
    echo -e "${RED}‚úó Tests failed${NC}"
    echo -e "${YELLOW}Fix the failing tests before pushing${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì All tests passed${NC}"

# 2. Check coverage threshold
echo "üìä Checking test coverage..."
COVERAGE=$(go tool cover -func=coverage.out 2>/dev/null | grep total | awk '{print $3}' | sed 's/%//')
if [ -n "$COVERAGE" ]; then
    echo -e "${BLUE}Total coverage: ${COVERAGE}%${NC}"

    # Warn if coverage is below 40%
    if (( $(echo "$COVERAGE < 40" | bc -l) )); then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Coverage is below 40% (${COVERAGE}%)${NC}"
        echo -e "${YELLOW}Consider adding more tests${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  Could not calculate coverage${NC}"
fi

# 3. Run build
echo "üî® Building all binaries..."
if ! make build > /dev/null 2>&1; then
    echo -e "${RED}‚úó Build failed${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Build successful${NC}"

# 4. Check for common issues
echo "üîç Checking for common issues..."

# Check for TODO/FIXME comments in staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
if [ -n "$STAGED_GO_FILES" ]; then
    TODO_COUNT=$(echo "$STAGED_GO_FILES" | xargs grep -n "TODO\|FIXME" 2>/dev/null | wc -l || echo "0")
    if [ "$TODO_COUNT" -gt 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Found $TODO_COUNT TODO/FIXME comment(s) in staged files${NC}"
        echo "$STAGED_GO_FILES" | xargs grep -n "TODO\|FIXME" 2>/dev/null || true
    fi
fi

# Check for debugging statements
DEBUG_COUNT=$(echo "$STAGED_GO_FILES" | xargs grep -n "fmt.Println\|log.Println\|panic(" 2>/dev/null | wc -l || echo "0")
if [ "$DEBUG_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Found potential debug statements:${NC}"
    echo "$STAGED_GO_FILES" | xargs grep -n "fmt.Println\|log.Println\|panic(" 2>/dev/null || true
fi

echo -e "${GREEN}‚úì Pre-push checks completed${NC}"

# 5. Final confirmation for main/master branches
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  You are pushing to $branch branch!${NC}"
    read -p "Are you sure you want to continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Push cancelled${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}‚úÖ All pre-push checks passed! Proceeding with push...${NC}"
echo ""

# Clean up coverage files
rm -f coverage.out coverage.txt

exit 0
